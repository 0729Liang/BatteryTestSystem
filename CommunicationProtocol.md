
# 电池测试系统说明文档


## 1.客户端控制命令格式

 帧头 |  总字节数  | 命令 | 设备号 |       通道号          | 校验和 |帧尾 
 ----|-----------|------|-------|----------------------|-------|----
 7B | 0x00 0x60 | 0x71 | 0x01  | 0x00 0x00 0x00 0x01  |  0x00 |7D 
    

[注:] 
```
    设备号：1字节
    通道号：
        启动，暂停，停止，恢复，清错误命令：通道位占4字节
        其余命令：通道位占1字节
```
控制命令：7B0000+命令字+设备号+通道位标志（2字节）+00+7D

例：
    启动命令：7B 0000 8F 01 0000 0001 007D
    
    查询状态：7B 0000 71 01 00 007D

## 2.命令详情

1、启动命令	0x8F：7B 0000 8F 01 0000 0001 007D

2、暂停命令	0x65

3、恢复命令	0x6A

4、查询数据	0x71：7B 0000 71 01 00 007D

5、清楚错误  0x6c

6、启动并机  0x44

7、停止命令  0x60

8、查询状态  0x80


举例： 

    设备0x01 通道0x01 发送启动测试0x8F:  7B 00 08 8F 01 0000 0001 00 7D
    设备0x01 通道0x02 发送暂停测试0x8F:  7B 00 08 65ß 01 0000 0002 00 7D


## 3.查询通道状态的返回数据格式

 帧头 |  总字节数  | 命令 | 设备号 |  设备模式 | 通道状态* | 是否并机(高位)* | 是否并机(低位)* | 错误代码* | 重复*标记为|校验和 |帧尾 
 ----|-----------|------|-------|----------|----------|---------------|---------------|----------|:---------:|------|----
 7BH | 0x00 0x00 | 0x80 | 0x01  |    0x00  |   0x01   |   0x00        |      0x00     |    0x00  |     ***   | 0x00 |7D 
 
 通道状态
 ```
    0x2,     //放电         
    0x3,     //间歇    
    0x4,     //斜坡充电    
    0x5,     //斜坡放电    
    0x10,    //出错             
    0x20,    //并机       
    0x1,     //充电            
    0x6,     //暂停     
    0x7F,    //选中状态       
    0x9,     //停止       
    0x99     //离线       
 ```

    注释
    1字节总帧头 7B   -> 0
    2字节长度        -> 1-2
    1字节命令（0x80） -> 3
    1字节设备号  -> 4
    1字节设备模式 -> 5
    
    4字节通道信息： 
        通道状态计算公式
            6 10 14 -> n(0-14) = 6+x*4
                    -> n(1-15) = 2+x*4
            共计16通道
                -> min=6;max=2+15*4=62
            
        通道状态 -> 6 -> n0 = 6+0*4 -> n1 = 2+1*4
        是否并机 -> 7
        是否并机 -> 8
        错误代码 -> 9
        ---
        通道状态 -> 10 -> n1 = 6+1*4 -> n2 = 2+2*4
        是否并机 -> 11
        是否并机 -> 12
        错误代码 -> 13
        ---
        通道状态 -> 14 -> n2 = 6+2*4 -> n3 = 2+3*4
        是否并机 -> 15
        是否并机 -> 16
        错误代码 -> 17
        *
        *
        *
        通道状态 -> 62 -> n15 = 6+14*4 -> n15 = 2+15*4=62
        是否并机 -> 63
        是否并机 -> 64
        错误代码 -> 65
        
        1字节校验和 ->66
        1字节帧尾 -> 67
        
        共计 68 位
        
        样例命令
        command：7B0000800100010000000100000009000000090000000900000009000000090000000900000009000000090000000900000009000000090000000900000009000000007D
         7B 00 00 80 01 00
             01000000 -> 通道0
             01000000 -> 通道1
             09000000 -> 通道2
             09000000 -> 通道3
             09000000 -> 通道4
             09000000 -> 通道5
             09000000 -> 通道6
             09000000 -> 通道7
             09000000 -> 通道8
             09000000 -> 通道9
             09000000 -> 通道10
             09000000 -> 通道11
             09000000 -> 通道12
             09000000 -> 通道13
             09000000 -> 通道14
         007D
        
        
    
## 4.客户端接收测试数据的协议格式

移动端  接收实时数据紧挨着来的（浮点值说明见最后）

说明：多字节的是高字节在前，低字节在后的顺序（大端）


大小端格式说明

十进制：   287454020

十六进制： 0x11223344

索引      |  0   | 1    | 2     |3
---------|------|------|-------|-----     
大端格式：| 0x11 |  0x22 | 0x33 | 0x44
小端格式：|0x44  |  0x33 | 0x22 |0x11

```
浮点值转换规则
2个字节浮点值解析：先转换成浮点数,然后除以100
4个字节浮点值解析：先转换成浮点数,然后除以1000
8个字节浮点值解析：先转换成浮点数,然后除以1000
```
如： 

设备0x02 通道 0x01 发来的测试数据：
7B000071**02**05060708017B01**01**0C1400000107000000D4000000AE000000DB000002B1C3A0C38F001A00510003003C000000510000029F0000028D0000022900000000000001C5000000000000000E010B0000011D000000BC000000000000067D007D00  ——                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                》 00 00 |00 00| 00|00|  06|7D|00|   7D00

总帧头| 2字节 |  命令 | 设备号* |    4字节   |   此条数据包含的通道数 | 通道帧头 | isSave(0:false,1：true)| 通道号* | 错误代码  |  模式  | 4字节电压浮点值* |   电流浮点值  |  功率浮点值  |  总安时浮点值 | 总瓦时浮点值 |    2个字节先转化成浮点值然后减去偏移量 得到温度1（中位机）*      | 2个字节先转化成浮点值然后减去偏移量 得到温度2（中位机） |  2个字节循环次数整数 |    2个字节内循环次数1整数      |     2个字节内循环次数2整数  |   2个字节内循环次数3整数 |  4个字节充电安时浮点值*   |  4个字节放电安时浮点值  |   4个字节充电瓦时浮点值 |   4个字节放电瓦时浮点值   |   8个字节 步测试时间浮点值*    |      8个字节 总测试时间浮点值    |    2个字节步号整数*   |  4个字节内阻浮点值     |  4个字节容量浮点值  |   2个字节并机标识整数   | 2个字节CAN变量整数    |  1个字节数采个数 | 1个字节数据变化标识，00-有变化，ff-数据无变化    | 1个字节校验 0  |1个字节跨过数据封装尾（通道尾） | 1条通道数数据87位，最多16通道  | 校验和 |帧尾                                                                                                                                         
-----|-------|------|:-----:|-------------|:-------------------:|---------|:----------------------:|--------|---------|-------|-----------------|-------------|-------------|-------------|-------------|:--------------------------------------------------------:|:------------------------------------------------:|:-----------------:|:---------------------------:|:------------------------:|:----------------------:|:----------------------:|:--------------------:|:--------------------:|:----------------------:|:---------------------------:|:-----------------------------:|:-------------------:|:-------------------:|:-----------------:|:---------------------:|:------------------:|:---------------:|:------------------------------------------:|:-------------:|:--------------------------:|:--------------------------:|-------|-----
  7B | 00 00 |  71  |   02  | 05 06 07 08 |           01        |   7B    |          01            |    01  |     0C  |   14  |   00 00 01 07   | 00 00 00 D4 | 00 00 00 AE | 00 00 00 DB | 00 00 02 B1 |             C3                     A0                    |             C3                   8F              |       00    1A    |          00    51           |         00  03           |      00      3C        |        00 00 00 51     |      00 00 02 9F     |     00  00   02  8D  |      00 00 02 29       | 00 00 00 00     00 00 01 C5 |  00 00 00 00      00 00 00 0E |          01 0B      |    00 00 01 1D      |     00 00 00 BC   |            00 00      |       00  00       |        00       |                      00                    |       06      |        7D                  |          ****              |    00 | 7D 


    注释:
    --------:注: 有几个7B就有几个7D，7B是通道/数据包的头，7D是通道/数据包的位，是一个数据包只含有一个设备的信息，可能会携带多个通道数据
    --------:共计长度99字节，索引范围0-98，
    --------:前10位（索引0-9）不重复，后两位（索引97-98）不重复
    --------:一条通道数据占87字节，最多16通道
    --------:最短包长度（只有1通道数据）：10*2+87*2+2*2=198位     即99字节
    --------:最长包长度（含16通道数据）：10*2+87*2*16+2*2=2808位  即1404字节
    -------------------------------------------------------------------------------------------
    详细说明
    前10位
    1字节总帧头 7B   ->0
    2字节长度       ->1-2
    1字节命令（0x71） ->3
    
    1个字节表示设备号*  ->4
    4个字节不用管 ->5-8
    1个字节表示此条数据包含的通道数（最大16位），后边跟着通道信息    ->9
    
    ----------------------------------------------------
    * 一条通道字节：174/2=87
    * 一条通道命令模板：7B***7D
    * 数据范围：
    *  通道1：10-96，
    *  通道2：97-183、
    *  通道3：184-270
    *  *
    *  *
    *  *
    *  通道x：10+87*x+offset  ~ 96+87*x+offset
    *
    * 通用公式：n(0-14)=10+87*x+offset
    * offset=数据索引-基数索引，范围10-96，基数索引是10，如isSave的索引是11，则offset=11-10=1
    *
    * 常用数据偏移量如下
    * 步时间：offset=53 位数：8位   单位 S    索引：63-70
    * 电流：offset=9   位数：4位   单位：A    索引：19-22
    * 电压：offset=5   位数：4位   单位：V    索引：15-18
    * 功率：offset=13  位数：4位   单位：W    索引：23-26
    * 温度：offset=25  位数：2位   单位：℃    索引：35-36
    * 安时：offset=17  位数：4位   单位：Ah   索引：27-30
    
    
    1个字节通道帧头 0x7B   ->10、97  公式：n(0-14)=10+（x+1）*87
    1个字节IsSave 1表示true 0表示false     ->11

    1个字节通道号*    ->12    *** offset=2
    1个字节状态字（错误代码）   ->13
    1个字节模式      ->14
    
    4个字节电压浮点值*  ->15-18   *** offset=5=15-10
    4个字节电流浮点值   ->19-22   *** offset=9
    4个字节功率浮点值   ->23-26   *** offset=13
    4个字节总安时浮点值  ->27-30  *** offset=17
    4个字节总瓦时浮点值  ->31-34
    
    2个字节先转化成浮点值然后减去偏移量 得到温度1（中位机）*  ->35-36  *** offset=25
    2个字节先转化成浮点值然后减去偏移量 得到温度2（中位机）   ->37-38  *** offset=27
    2个字节循环次数整数  ->39-40
    2个字节内循环次数1整数    ->41-42
    2个字节内循环次数2整数    ->43-44
    2个字节内循环次数3整数    ->45-46
    
    4个字节充电安时浮点值*    ->47-50
    4个字节放电安时浮点值     ->51-54
    4个字节充电瓦时浮点值     ->55-58
    4个字节放电瓦时浮点值     ->59-62
    
    8个字节步测试时间浮点值*   ->63-70 *** offset=53
    8个字节总测试时间浮点值    ->71-78
    
    2个字节步号整数*    ->79-80
    4个字节内阻浮点值   ->81-84
    4个字节容量浮点值   ->85-88
    2个字节并机标识整数 ->89-90
    2个字节CAN变量整数  ->91-92
    1个字节数采个数     ->93
    
    1个字节数据变化标识，00-有变化，ff-数据无变化* ->94
    1个字节校验 0    ->95
    1个字节跨过数据封装尾 0x7D ->96 
            废弃：1字节通道帧尾     ->97 
    -------------------------------
    
    1字节校验和  -> 97
    总帧尾 0x7D    ->98
    
    样本命令：
    
    // 设备1 通道1 
    7B0000 71 01（设备号）00000000 01（包含的通道数）7B、01（是否保存）、：01（通道号）72FD 00000067（电压）0000016D（电流）000000D6（功率）00000347（总安时）000000CC（总瓦时）C377（温度1）C3B3（温度2）0062（循环次数）004C（循环1）0015（循环2）000B（循环3）000002FF000000E9000001E40000038F 0000000000000329（步时间）00000000000001B9（总时间）00E6 00000138 00000270（容量）0000 0000 00（采）00 06 7D（通道帧尾）007D
    7B0000710100000000017B010172FD000000670000016D000000D600000347000000CCC377C3B30062004C0015000B000002FF000000E9000001E40000038F000000000000032900000000000001B900E60000013800000270000000000000067D007D
    
    // 设备1 通道 12
    7B0000 71 01（设备号）00000000 02（包含的通道数）7B、01（是否保存）、：01（通道号）40F6 0000020D（电压）00000342（电流）00000203（功率）000001D4（总安时）0000037B（总瓦时）C368（温度1）C386（温度2）0052（循环次数）0018（循环1）001B（循环2）0002（循环3）0000015A000001BF000002C40000025D 000000000000028A（步时间）0000000000000331（总时间）01FA 00000209 00000047（容量）0000 0000 00（采）00 06 7D（通道帧尾）7B010240F60000020D0000034200000203000001D40000037BC368C38600520018001B00020000015A000001BF000002C40000025D000000000000028A000000000000033101FA0000020900000047000000000000067D007D
    7B0000710100000000027B010140F60000020D0000034200000203000001D40000037BC368C38600520018001B00020000015A000001BF000002C40000025D000000000000028A000000000000033101FA0000020900000047000000000000067D7B010240F60000020D0000034200000203000001D40000037BC368C38600520018001B00020000015A000001BF000002C40000025D000000000000028A000000000000033101FA0000020900000047000000000000067D007D
    
    
    
    
   
    
     
    












 